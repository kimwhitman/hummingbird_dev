# AGENTS.md

**Project:** Hummingbird
**Last Updated:** 2025-01-23
**Type:** Early Childhood Education Platform (Web Application)
**Stack:** AI-Optimized for 100% AI-Generated Code
**Architecture:** Next.js 15 + Convex + Clerk + Vercel AI SDK

This file provides guidance to AI coding agents working in this codebase.

---

## ğŸ¤– CRITICAL: This Project is AI-First

**100% of code in this repository is generated by AI agents following MVC (Minimum Viable Context) protocol.**

**Implications:**
- All code must be **declarative** and **self-documenting**
- Technologies chosen for **maximum training corpus coverage**
- Architecture optimized for **narrow context slices**
- Patterns must be **standard** (not novel)

See `docs/protocols/AI-STACK-OPTIMIZATION-v1.0.md` for stack selection rationale.

---

## Development Environment

### Runtime & Package Manager

```bash
# Install dependencies (using Bun)
bun install

# Development (all apps)
bun run dev

# Development (specific app)
bun --filter @hummingbird/web dev
bun --filter @hummingbird/convex dev

# Build
bun run build

# Test
bun run test

# Type check
bun run typecheck
```

### Prerequisites

- **Bun** v1.0+ (install via `brew install bun`)
- **Node.js** 20+ (for Vercel deployment)
- **TypeScript** 5.x (installed as dev dependency)

### Environment Setup

```bash
# Copy example env files
cp apps/web/.env.local.example apps/web/.env.local

# Required services:
# 1. Convex: Create project at https://convex.dev
# 2. Clerk: Create application at https://clerk.com
# 3. Anthropic: Get API key at https://console.anthropic.com
```

**Environment Variables:**
- `NEXT_PUBLIC_CONVEX_URL` - Convex deployment URL
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - Clerk publishable key
- `CLERK_SECRET_KEY` - Clerk secret key
- `ANTHROPIC_API_KEY` - For AI features (captions, moderation)

---

## Project Architecture

### Monorepo Structure

```
hummingbird/
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ web/                     # Next.js 15 app (web + PWA)
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ app/            # App Router pages
â”‚       â”‚   â”œâ”€â”€ components/     # React components
â”‚       â”‚   â””â”€â”€ lib/            # Utilities
â”‚       â”œâ”€â”€ public/             # Static assets
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ convex/                 # Convex backend
â”‚   â”‚   â””â”€â”€ convex/
â”‚   â”‚       â”œâ”€â”€ schema.ts       # Database schema (declarative)
â”‚   â”‚       â”œâ”€â”€ posts.ts        # Posts API
â”‚   â”‚       â””â”€â”€ assignments.ts  # Permissions/roles
â”‚   â”‚
â”‚   â”œâ”€â”€ ui/                     # Shared UI components (shadcn/ui)
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚
â”‚   â””â”€â”€ types/                  # Shared TypeScript types
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ index.ts        # Role types, etc.
â”‚
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ protocols/              # PSA protocols
â”‚       â”œâ”€â”€ MVC-METHOD-v1.0.md
â”‚       â””â”€â”€ AI-STACK-OPTIMIZATION-v1.0.md
â”‚
â”œâ”€â”€ turbo.json                  # Turborepo config
â”œâ”€â”€ package.json                # Root package.json
â””â”€â”€ AGENTS.md                   # This file
```

### Key Architectural Patterns

- **Frontend:** Next.js 15 App Router (file-based routing, Server Components)
- **Backend:** Convex (serverless, real-time, type-safe functions)
- **Database:** Convex schema (declarative, no migrations)
- **Auth:** Clerk (pre-built components, social/email/phone auth)
- **AI:** Vercel AI SDK (streaming, tool calling)
- **UI:** shadcn/ui + Radix + Tailwind (copy-paste components)
- **Forms:** React Hook Form + Zod (type-safe validation)
- **State:** Zustand (simple global state)
- **Real-time:** Convex subscriptions (built-in, no WebSocket setup)

---

## AI Agent Guidelines

### ğŸ¯ Core Principles for AI Agents

1. **Follow MVC Protocol** (`docs/protocols/MVC-METHOD-v1.0.md`)
   - Work in narrow slices
   - Only edit specified files
   - Provide evidence bundles

2. **Use Standard Patterns**
   - Copy from training data (Next.js, React, Convex examples)
   - Don't invent novel abstractions
   - Favor declarative over imperative

3. **Types Guide You**
   - Read schema first (`packages/convex/convex/schema.ts`)
   - Let TypeScript catch errors
   - Types flow automatically (don't manually annotate)

4. **Self-Documenting Code**
   - Next agent won't have context from previous slices
   - File names must be obvious (`createPost.tsx`, not `cp.tsx`)
   - Functions must be clear (`getPostsByClassroom`, not `fetch`)

### ğŸ“‹ Common MVC Slices

#### Slice: Add New Database Table

```
Guardrails: Only edit packages/convex/convex/schema.ts
Task:
  1. Read existing schema for patterns
  2. Add new table with defineTable()
  3. Add indexes as needed
  4. Run: bun --filter @hummingbird/convex dev (verify schema compiles)
Acceptance:
  - Schema compiles without errors
  - Indexes created
  - No breaking changes to existing tables
```

**AI Success Rate:** ~95%

#### Slice: Add Convex Mutation

```
Guardrails: Only edit packages/convex/convex/<resource>.ts
Reading List:
  - packages/convex/convex/schema.ts (for table structure)
  - Convex docs: https://docs.convex.dev/functions/mutations
Task:
  1. Import mutation from ./_generated/server
  2. Define args with v.* validators
  3. Implement handler
  4. Test in Convex dashboard
Acceptance:
  - Mutation runs in dashboard
  - Args validated
  - Returns expected type
```

**AI Success Rate:** ~90%

#### Slice: Add Next.js Page

```
Guardrails: Only edit apps/web/src/app/<path>/page.tsx
Reading List:
  - Next.js App Router docs
  - apps/web/src/app/page.tsx (for patterns)
Task:
  1. Create page.tsx in appropriate directory
  2. Use async Server Component if fetching data
  3. Call Convex queries/mutations
  4. Run: bun --filter @hummingbird/web dev (verify page renders)
Acceptance:
  - Page renders at correct route
  - Data fetches successfully
  - No TypeScript errors
```

**AI Success Rate:** ~95%

#### Slice: Add React Component with Form

```
Guardrails: Only edit apps/web/src/components/<name>/
Reading List:
  - React Hook Form docs
  - packages/ui/src/components/button.tsx (for shadcn pattern)
Task:
  1. Use useForm from react-hook-form
  2. Define Zod schema for validation
  3. Use shadcn/ui components (Button, Input, etc.)
  4. Call Convex mutation on submit
Acceptance:
  - Form validates with Zod
  - Submits to Convex mutation
  - Shows success/error states
  - TypeScript compiles
```

**AI Success Rate:** ~85%

---

## Stack-Specific Guidelines

### Next.js 15 (App Router)

**DO:**
- âœ… Use Server Components by default
- âœ… Use Client Components ("use client") for interactivity
- âœ… File-based routing (app/classroom/[id]/page.tsx)
- âœ… Async Server Components for data fetching
- âœ… Import from @hummingbird/ui for shared components

**DON'T:**
- âŒ Use pages/ directory (we use App Router)
- âŒ Use getServerSideProps (use async Server Components)
- âŒ Create API routes in app/api (use Convex instead)

### Convex

**DO:**
- âœ… Define schema declaratively in schema.ts
- âœ… Use indexes for all queries
- âœ… Return types automatically infer from schema
- âœ… Test functions in Convex dashboard before UI integration

**DON'T:**
- âŒ Write migrations (Convex handles schema evolution)
- âŒ Use SQL (Convex is NoSQL document store)
- âŒ Forget permission checks (add TODO comments for auth)

### Clerk

**DO:**
- âœ… Use pre-built components (<SignIn />, <SignUp />)
- âœ… Wrap app in <ClerkProvider>
- âœ… Use useUser() hook for client-side auth
- âœ… Use auth() in Server Components

**DON'T:**
- âŒ Build custom auth UI (use Clerk components)
- âŒ Store sensitive data in public metadata
- âŒ Forget to check auth in Convex mutations

### shadcn/ui + Tailwind

**DO:**
- âœ… Copy components from packages/ui/src/components/
- âœ… Use cn() utility for className merging
- âœ… Use Tailwind utility classes
- âœ… Follow Radix UI patterns (Button, Dialog, etc.)

**DON'T:**
- âŒ Write custom CSS files
- âŒ Use inline styles
- âŒ Install UI libraries (use shadcn/ui)

---

## 35+ Role Permission System

**See:** `packages/types/src/index.ts` for all roles

**Architecture:**
- **Authentication:** Clerk (who you are)
- **Authorization:** Convex `assignments` table (what you can do)

**How It Works:**
1. User logs in with Clerk â†’ gets `userId`
2. Check `assignments` table for user's roles + scopes
3. Enforce permissions in Convex queries/mutations

**Example Permission Check:**

```typescript
// packages/convex/convex/permissions.ts
export const canViewPost = async (
  ctx: QueryCtx,
  userId: string,
  postId: string
): Promise<boolean> => {
  const post = await ctx.db.get(postId);
  if (!post) return false;

  // Check if user is teacher in this classroom
  const teacherAssignment = await ctx.db
    .query("assignments")
    .withIndex("by_user", (q) => q.eq("userId", userId))
    .filter((q) =>
      q.and(
        q.eq(q.field("scopeType"), "classroom"),
        q.eq(q.field("scopeId"), post.classroomId),
        q.or(
          q.eq(q.field("role"), "lead_teacher"),
          q.eq(q.field("role"), "assistant_teacher")
        )
      )
    )
    .first();

  if (teacherAssignment) return true;

  // Check if user is guardian of tagged child
  // ... (implement child-scoped permissions)

  return false;
};
```

---

## AI Features (Vercel AI SDK)

**Current AI Features:**
1. **Auto-captions** - Generate captions for teacher photos
2. **Translations** - Multi-lingual family support
3. **Content moderation** - Safety checks for children's photos

**Example: Auto-Caption Generation**

```typescript
// app/api/ai/caption/route.ts
import { anthropic } from '@ai-sdk/anthropic';
import { generateText } from 'ai';

export async function POST(req: Request) {
  const { imageUrl } = await req.json();

  const { text } = await generateText({
    model: anthropic('claude-3-5-sonnet-20241022'),
    messages: [
      {
        role: 'user',
        content: [
          { type: 'image', image: imageUrl },
          { type: 'text', text: 'Describe this classroom activity for parents in 1-2 sentences.' }
        ],
      },
    ],
  });

  return Response.json({ caption: text });
}
```

**Don't Build Yet:**
- âŒ Multi-model routing (premature optimization)
- âŒ MCP Protocol (too new for AI agents)
- âŒ Complex agent orchestration

**Add Post-MVP:**
- â­ Curriculum gap analysis (semantic search over posts)
- â­ Daily summary generation (scheduled AI job)
- â­ Smart child tagging (face recognition)

---

## Testing Strategy

### Unit Tests
```bash
# Coming soon - add tests as features stabilize
bun test
```

### Type Checking
```bash
# Run before every commit
bun run typecheck
```

### Manual Testing
1. Convex Dashboard - Test queries/mutations
2. Browser DevTools - Test UI components
3. Clerk Dashboard - Test auth flows

---

## Deployment

### Vercel (Frontend)
```bash
# Deploy Next.js app
vercel deploy

# Environment variables set in Vercel dashboard
```

### Convex (Backend)
```bash
# Deploy Convex functions
bun --filter @hummingbird/convex deploy

# Convex handles schema migrations automatically
```

---

## Common Pitfalls for AI Agents

### âŒ Pitfall: Editing Multiple Packages in One Slice
**Wrong:**
```
Slice: Add posts feature
Files: packages/convex/convex/posts.ts, apps/web/src/app/feed/page.tsx
```

**Right:**
```
Slice 1: Add posts schema + mutations (Convex only)
Slice 2: Add feed page (Next.js only)
```

**Why:** Narrow scope = higher success rate

### âŒ Pitfall: Inventing Novel Abstractions
**Wrong:**
```typescript
// Custom abstraction AI invented
const useSuperQuery = (query) => { /* complex logic */ }
```

**Right:**
```typescript
// Standard Convex pattern from docs
const posts = useQuery(api.posts.getByClassroom, { classroomId });
```

**Why:** Next AI agent won't understand your custom hook

### âŒ Pitfall: Missing Permission Checks
**Wrong:**
```typescript
export const deletePost = mutation({
  handler: async (ctx, args) => {
    await ctx.db.delete(args.postId); // No auth check!
  }
});
```

**Right:**
```typescript
export const deletePost = mutation({
  handler: async (ctx, args) => {
    // TODO: Add auth check (MVC slice: implement permissions)
    // const canDelete = await canUserDeletePost(ctx, userId, args.postId);
    // if (!canDelete) throw new Error("Unauthorized");

    await ctx.db.delete(args.postId);
  }
});
```

**Why:** Leave TODOs for future slices, but don't ship without auth

---

## Resources

- **Next.js Docs:** https://nextjs.org/docs
- **Convex Docs:** https://docs.convex.dev
- **Clerk Docs:** https://clerk.com/docs
- **Vercel AI SDK:** https://sdk.vercel.ai/docs
- **shadcn/ui:** https://ui.shadcn.com
- **React Hook Form:** https://react-hook-form.com
- **Zod:** https://zod.dev

---

## Protocols

This project follows PSA (Protocol for Software Agents) standards:

- **MVC Method** - Minimum Viable Context for AI agents (`docs/protocols/MVC-METHOD-v1.0.md`)
- **AI Stack Optimization** - Technology selection for AI code generation (`docs/protocols/AI-STACK-OPTIMIZATION-v1.0.md`)

---

_This file is maintained as part of the PSA protocol and follows the industry standard AGENTS.md format._
